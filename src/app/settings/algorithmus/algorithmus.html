<div class="container-preise">
  <h2>Leistungsübersicht</h2>

  <div class="main-wrapper">
    <div class="wrapper-content" [ngClass]="showEdit ? 'show-edit' : ''">
      <div class="container-prices">
        <table class="price-table">
          <thead>
            <tr>
              <th>Leistung</th>
              <th>Preis</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Grundgebühr</td>
              <td>{{ algorithmusControl.basicFeeProvision | number : '1.2-2' }} €</td>
            </tr>
            <tr>
              <td>Individuelle Express Krypto-Einführung</td>
              <td>{{ algorithmusControl.firstStepProvision | number : '1.2-2' }} %</td>
            </tr>
            <tr>
              <td>Börsenwahl & Einrichtung</td>
              <td>{{ algorithmusControl.exchangeSetupProvision | number : '1.2-2' }} %</td>
            </tr>
            <tr>
              <td>Kaufstrategie & Coin-Auswahl</td>
              <td>{{ algorithmusControl.buyStrategyProvision | number : '1.2-2' }} %</td>
            </tr>
            <tr>
              <td>Wallet-Einrichtung & Sicherheit</td>
              <td>{{ algorithmusControl.walletSetupProvision | number : '1.2-2' }} %</td>
            </tr>
            <tr>
              <td>Steuertool für deine Abwicklung</td>
              <td>{{ algorithmusControl.taxToolProvision | number : '1.2-2' }} %</td>
            </tr>
            <tr>
              <td>Laufende Betreuung</td>
              <td>{{ algorithmusControl.ongoingSupportProvision | number : '1.2-2' }} €</td>
            </tr>
          </tbody>
        </table>
        <button class="edit" (click)="editDetails()">EDIT</button>
      </div>

      <!-- EDIT -->

      <div class="container-edit">
        <form [formGroup]="algorithmusForm" (ngSubmit)="onSubmit()">
          <div class="services" formArrayName="services">
            @for (service of services.controls; track $index) {

            <div class="service" [formGroupName]="$index">
              <!-- Name -->
              <div class="form-group">
                <!-- <label for="name">Name</label> -->
                <input
                  id="name"
                  type="text"
                  class="form-control"
                  formControlName="name"
                  placeholder="service"
                />

                @if ( service.get('name')?.invalid && (service.get('name')?.touched ||
                service.get('name')?.dirty) ) {
                <div class="text-requied">
                  @if (service.get('name')?.errors?.['required']) {
                  <small>Name ist erforderlich.</small>
                  } @if (service.get('name')?.errors?.['maxlength']) {
                  <small>Name darf maximal 200 Zeichen lang sein.</small>
                  }
                </div>
                }
              </div>

              <!-- Provision Type -->
              <div class="form-group">
                <!-- <label for="provision_type">Provision type</label> -->
                <select id="provision_type" class="form-control" formControlName="provision_type">
                  <option value="">Keine Angabe</option>
                  @for (type of provisionTypes; track type.value) {
                    <option [value]="type.value">
                      {{ type.label }}
                    </option>
                  }
                </select>
              </div>

              <!-- Fixed amount -->
              @if (isFixed($index)) {
              <div class="form-group">
                <!-- <label for="amount_fixed">Fixed amount (€)</label> -->
                <input
                  id="amount_fixed"
                  type="number"
                  step="0.01"
                  class="form-control"
                  formControlName="amount_fixed"
                  placeholder="Festbetrag (€)"
                />

                @if ( service.get('amount_fixed')?.invalid &&
                (service.get('amount_fixed')?.touched ||
                service.get('amount_fixed')?.dirty) ) {
                <div class="text-requied">
                  @if (service.get('amount_fixed')?.errors?.['required']) {
                  <small>Fixbetrag ist erforderlich.</small>
                  } @if (service.get('amount_fixed')?.errors?.['min']) {
                  <small>Fixbetrag muss größer als 0 sein.</small>
                  } @if (service.get('amount_fixed')?.errors?.['pattern']) {
                  <small>Ungültiges Zahlenformat (z. B. 700.00).</small>
                  }
                </div>
                }
              </div>
              }

              <!-- Percent amount -->
              @if (!isFixed($index)) {
              <div class="form-group">
                <!-- <label for="amount_percent">Percent (decimal)</label> -->
                <input
                  id="amount_percent"
                  type="number"
                  step="0.0001"
                  class="form-control"
                  formControlName="amount_percent"
                  placeholder="Prozent (decimal)"
                />

                @if ( service.get('amount_percent')?.invalid &&
                (service.get('amount_percent')?.touched ||
                service.get('amount_percent')?.dirty) ) {
                <div class="text-requied">
                  @if (service.get('amount_percent')?.errors?.['required']) {
                  <small>Prozentwert ist erforderlich.</small>
                  } @if ( service.get('amount_percent')?.errors?.['min'] ||
                  service.get('amount_percent')?.errors?.['max'] ) {
                  <small>Wert muss zwischen 0 und 1 liegen (z. B. 0.05).</small>
                  } @if (service.get('amount_percent')?.errors?.['pattern']) {
                  <small>Ungültiges Dezimalformat.</small>
                  }
                </div>
                }
              </div>
              }
            </div>
            }
            <button type="button" (click)="addService()" [disabled]='!algorithmusForm.valid' >Neue</button>
          </div>
          <div class="btn-container">
            <!-- Cancel Button -->
            <button type="button" (click)="onCancel()">Abbrechen</button>
  
            <!-- Submit Button -->
            <button type="submit" >Speichern</button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>
